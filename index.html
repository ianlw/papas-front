<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cámara con Predicción</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
</head>
<body class="bg-light">

    <div class="container py-5">
        <h1 class="text-center text-primary mb-48">Cámara y Predicción</h1>
        
        <!-- Video para capturar -->
        <div class="d-flex justify-content-center">
            <video id="video" autoplay class="border rounded shadow w-100" style="max-width: 600px;"></video>
        </div>
        
        <!-- Botones -->
        <div class="text-center mt-4">
            <button id="capture-btn" class="btn btn-primary" disabled>Capturar y Enviar Foto</button>
        </div>

        <!-- Canvas oculto -->
        <canvas id="canvas" style="display:none;"></canvas>

        <!-- Modal con transición de opacidad -->
        <div id="modal" class="modal fade" tabindex="-1" aria-labelledby="modalLabel" aria-hidden="true">
            <div class="modal-dialog modal-dialog-centered">
                <div class="modal-content">
      
                    <div class="modal-body text-center">
                        <img id="captured-image" class="img-fluid rounded mb-4" alt="Imagen capturada" style="display: none;">
                        <!-- Spinner de carga (invisible inicialmente) -->
                        <div id="loading-spinner" class="d-flex justify-content-center mb-4">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                        </div>
                        <!-- <a id="close-modal" type="button" data-bs-dismiss="modal" aria-label="Salir">Salir</a> -->

                        <!-- Imagen capturada -->

                        <!-- Predicción (invisible inicialmente) -->
                        <p id="prediction" class="text-success font-weight-bold" style="display: none;"></p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const video = document.getElementById('video');
        const captureBtn = document.getElementById('capture-btn');
        const canvas = document.getElementById('canvas');
        const modal = new bootstrap.Modal(document.getElementById('modal'));
        const capturedImage = document.getElementById('captured-image');
        const predictionText = document.getElementById('prediction');

        // URL del servidor backend
        const serverUrl = "https://papas-back.onrender.com/predict";

        // Iniciar cámara
        async function startCamera() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ video: true });
                video.srcObject = stream;
                captureBtn.disabled = false;
            } catch (error) {
                alert("No se pudo acceder a la cámara: " + error.message);
            }
        }

        // Capturar imagen y enviar al servidor
        captureBtn.addEventListener('click', async () => {
            // Captura la imagen desde el video
            const context = canvas.getContext('2d');
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            context.drawImage(video, 0, 0, canvas.width, canvas.height);

            // Convertir la imagen a Blob (archivo)
            canvas.toBlob(async (blob) => {
                const formData = new FormData();
                formData.append('file', blob, 'captura.jpg');

                // Mostrar el modal
                modal.show();

                // Mostrar el spinner de carga y ocultar la imagen y predicción
                capturedImage.style.display = 'none';
                        capturedImage.src = canvas.toDataURL();
                        capturedImage.style.display = 'block';
                predictionText.style.display = 'none';
                        document.getElementById('loading-spinner').classList.remove('d-none');

                try {
                    // Enviar la imagen al servidor
                    const response = await fetch(serverUrl, {
                        method: 'POST',
                        body: formData,
                    });

                    if (response.ok) {
                        const data = await response.json();
                        // Mostrar la predicción
                        predictionText.textContent = `Predicción: ${data.prediction}`;
                        predictionText.style.display = 'block';
                        document.getElementById('loading-spinner').classList.add('d-none');
                    } else {
                        predictionText.textContent = `Error en el servidor: ${response.statusText}`;
                        predictionText.style.display = 'block';
                    }
                } catch (error) {
                    predictionText.textContent = `Error al enviar la imagen: ${error.message}`;
                    predictionText.style.display = 'block';
                }
            }, 'image/jpeg');
        });

        // Iniciar la cámara al cargar la página
        window.addEventListener('load', startCamera);
    </script>
</body>
</html>
